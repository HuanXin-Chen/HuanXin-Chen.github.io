---
import { Image } from "astro:assets";
import { SITE } from "@config";
import Layout from "@layouts/Layout.astro";
import Header from "@components/Header.astro";
import Footer from "@components/Footer.astro";
import "@fancyapps/ui/dist/fancybox/fancybox.css";
import Main from "../layouts/Main.astro";
import Breadcrumbs from "../components/Breadcrumbs.astro";

const images = import.meta.glob<{ default: ImageMetadata }>(
  "../content/photo/*.{jpg,jpeg,png,webp}"
);
---

<Layout title={`My Photography Works | ${SITE.title}`}>
  <Header activeNav="photo" />
  <Breadcrumbs />
  <main id="desc">
    <section id="about" class="prose max-w-4xl prose-img:border-0">
      <h1 class="text-2xl tracking-wider sm:text-2xl">My Photography Works</h1>
      <a href="/moments/" class="mb-6 mt-2 italic"
        >Click here to view all moments! ğŸ‘ˆ</a
      >
    </section>
  </main>
  <main class="py-8">
    <section class="justified-gallery" id="photoswipe">
      {
        Object.entries(images).map(async ([_path, image], index) => {
          const { default: imageData } = await image();
          return (
            <a
              style={`--width: ${imageData.width}; --height: ${imageData.height};`}
              data-fancybox="gallery"
              data-src={imageData.src}
              target="_blank"
              class="cursor-pointer"
            >
              <Image
                format="webp"
                src={imageData}
                alt=""
                height={400}
                loading={index < 20 ? "eager" : "lazy"}
              />
            </a>
          );
        })
      }
    </section>
  </main>
  <Footer />
</Layout>

<script>
  import { Fancybox } from "@fancyapps/ui/dist/fancybox/";

  // ä½¿ç”¨äº‹ä»¶å§”æ‰˜ç¡®ä¿æŒç»­å·¥ä½œ
  document.addEventListener("click", function (e) {
    // ç±»å‹æ£€æŸ¥ç¡®ä¿ target æ˜¯ Element
    if (!(e.target instanceof Element)) return;

    // æŸ¥æ‰¾æœ€è¿‘çš„å¸¦æœ‰ data-fancybox å±æ€§çš„ç¥–å…ˆå…ƒç´ 
    const link = e.target.closest("[data-fancybox]");
    if (link) {
      e.preventDefault();

      // è·å–æ‰€æœ‰å¸¦æœ‰ç›¸åŒ gallery åç§°çš„å…ƒç´ 
      const galleryName = link.getAttribute("data-fancybox");
      const allGalleryItems = document.querySelectorAll(
        `[data-fancybox="${galleryName}"]`
      );

      // æ„å»ºå›¾ç‰‡æ•°ç»„
      const images = Array.from(allGalleryItems)
        .map(item => {
          const src =
            item.getAttribute("data-src") || item.getAttribute("href");
          if (!src) return null;
          return { src, type: "image" };
        })
        .filter((item): item is { src: string; type: string } => item !== null);

      // è·å–å½“å‰ç‚¹å‡»å…ƒç´ çš„ç´¢å¼•
      const currentIndex = Array.from(allGalleryItems).indexOf(link);

      // åˆ›å»ºæ–°çš„ Fancybox å®ä¾‹æ˜¾ç¤ºæ•´ä¸ªç”»å»Š
      Fancybox.show(images, {
        theme: "auto",
        mainStyle: {
          "--f-button-width": "44px",
          "--f-button-height": "44px",
          "--f-button-border-radius": "50%",
          "--f-toolbar-padding": "16px",
        },
        Carousel: {
          Arrows: false,
          Toolbar: {
            display: {
              left: [],
              middle: [],
              right: ["close"],
            },
          },
          transition: "slide",
        },
        startIndex: currentIndex, // ä»å½“å‰ç‚¹å‡»çš„å›¾ç‰‡å¼€å§‹
      });
    }
  });
</script>

<style>
  .justified-gallery {
    --padding: 8px; /* å‡å°å®¹å™¨å†…è¾¹è· */
    --space: 8px; /* å‡å°å›¾ç‰‡é—´è· */
    --columns: 3; /* é»˜è®¤åˆ—æ•° */

    padding: var(--padding);
    column-count: var(--columns);
    column-gap: var(--space);
  }

  .justified-gallery a {
    display: block;
    margin-bottom: var(--space);
    break-inside: avoid;
    overflow: hidden;
    opacity: 1;
    transition: all 0.05s ease-in-out;
  }

  .justified-gallery a img {
    display: block;
    object-fit: cover;
    width: 100%;
    height: auto;
  }

  .justified-gallery a:focus-visible {
    outline: 3px solid var(--outline);
    outline-offset: 2px;
    transform: scale(1.05);
    z-index: 1;
    border-radius: 2px;
    box-shadow: 0 2px 4px 2px rgba(0, 0, 0, 0.1);
  }

  .justified-gallery a.hidden {
    transition: opacity 0.4s ease-in-out;
    opacity: 0;
  }

  /* å“åº”å¼åˆ—æ•°è°ƒæ•´ */
  @media (max-width: 1200px) {
    .justified-gallery {
      --columns: 3;
    }
  }

  @media (max-width: 992px) {
    .justified-gallery {
      --columns: 2;
    }
  }

  @media (max-width: 576px) {
    .justified-gallery {
      --columns: 2; /* ä¿®æ”¹è¿™é‡Œï¼Œä»1æ”¹ä¸º2 */
    }
  }
</style>
